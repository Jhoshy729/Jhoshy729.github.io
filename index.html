<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carlos: Expedici√≥n Extrema</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: manipulation; }
        canvas { border: 4px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: block; max-width: 100%; height: auto; }
        
        .overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; }
        
        #pantallaInicio { display: flex; background: rgba(0,0,0,0.9); }
        #pantallaFinal { background: linear-gradient(to right, #0919ac, #5f6fff,#daa2ff, #fe7b7b, #ac0909); color: #000; text-shadow: 1px 1px 10px white; }
        #chicaAnimada { background: linear-gradient(30deg, rgba(255, 123, 0, 0.76), rgba(128, 83, 0, 0.795) 50%, rgba(255, 174, 0, 0.815)); width: 150px; height: 180px; margin-bottom: 10px; transition: transform 0.1s; }
        #pantallaPerder { background: rgba(0, 0, 0, 0.9); color: #fff; }
        
        .btn-restart, .btn-start { padding: 15px 35px; font-size: 20px; font-weight: bold; cursor: pointer; background: #ff4757; color: white; border: none; border-radius: 50px; margin-top: 20px; transition: 0.3s; }
        
        /* Controles M√≥viles */
        #controles-movil { position: fixed; bottom: 10px; width: 100%; display: none; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 1000; pointer-events: none; }
        .controles-grupo { display: flex; gap: 10px; pointer-events: auto; align-items: center; }
        .cruceta { display: grid; grid-template-columns: 60px 60px; gap: 5px; }
        .btn-touch { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-ataque { background: rgba(255, 71, 87, 0.6); width: 80px; height: 80px; font-size: 18px; }

        @media (pointer: coarse) { #controles-movil { display: flex; } }
    </style>
</head>
<body>

    <div id="pantallaInicio" class="overlay">
        <h1>„Ç´„É´„É≠„Çπ: EXPEDICI√ìN sopresa</h1>
        <p> Hola...ÊÑõ„Åó„Å¶„Åæ„Åô.</p>
        <button class="btn-start" onclick="iniciarJuego()">INICIAR AVENTURA</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="controles-movil">
        <div class="controles-grupo">
            <div class="cruceta">
                <div id="tIzq" class="btn-touch">‚Üê</div>
                <div id="tDer" class="btn-touch">‚Üí</div>
                <div id="tUp" class="btn-touch">‚Üë</div>
                <div id="tDown" class="btn-touch">‚Üì</div>
            </div>
        </div>
        <div class="controles-grupo">
            <div id="tAtk" class="btn-touch btn-ataque">¬°ATACA!</div>
        </div>
    </div>

    <div id="pantallaFinal" class="overlay">
        <img id="chicaAnimada" src="img/chica1.png" alt="Felicidad">
        <h1>üéÇ ¬°MISI√ìN CUMPLIDA CARLOS! üéÇ</h1>
        <h3>Feliz cumplea√±os mi terroncito de az√∫car, tarde muchas noches programando y pensando en c√≥mo hacerte una aventura especial... Te amo mucho mi vida. ‚ù§Ô∏è</h3>
        <p>¬°Hora De Comer Pastel, √ëan √ëan!</p>
        <button class="btn-restart" onclick="location.reload()">REINICIAR AVENTURA</button>
    </div>

    <div id="pantallaPerder" class="overlay">
        <h1>HAS CA√çDO EN COMBATE</h1>
        <button class="btn-restart" onclick="location.reload()">REINTENTAR</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 450;

    // --- RECURSOS ---
    const imgFondo1 = new Image(); imgFondo1.src = 'img/fondo_nivel1.png';
    const imgFondo2 = new Image(); imgFondo2.src = 'img/fondo_nivel2.png';
    const imgFondo3 = new Image(); imgFondo3.src = 'img/fondo_nivel3.jpeg';
    const imgPuerta = new Image(); imgPuerta.src = 'img/puerta.png';
    const imgJefe = new Image(); imgJefe.src = 'img/jefe.png';
    const imgLadron = new Image(); imgLadron.src = 'img/ladron.png';

    function cargarSerie(nombre, total) {
        let temp = [];
        for(let i=1; i<=total; i++) {
            let img = new Image(); img.src = `img/${nombre}${i}.png`;
            temp.push(img);
        }
        return temp;
    }

    const sprites = {
        camina: cargarSerie('carlos_camina', 6),
        salta: cargarSerie('carlos_salta', 6),
        ataca: cargarSerie('carlos_ataca', 4),
        pierde: cargarSerie('carlos_pierde', 4)
    };

    const sfxFondo = new Audio('audio_nivel.mp3'); sfxFondo.loop = true;
    const sfxAtaque = new Audio('audio_ataque.mp3');
    const sfxEnemigo = new Audio('audio_enemigo.mp3');
    const sfxPerder = new Audio('audio_perder.mp3');
    const sfxFinal1 = new Audio('audio_final1.mp3');
    const sfxFinal2 = new Audio('audio_final2.mp3');

    let nivel = 1; let juegoActivo = false; let mirandoIzquierda = false;
    let animFrame = 0; let animTimer = 0;
    const sueloY = 380;
    const keys = {};

    const carlos = { x: 50, y: sueloY - 150, w: 70, h: 120, hp: 100, vy: 0, gravedad: 1.2, salto: -20, enSuelo: true, speed: 6, atacando: false, muerto: false };
    const jefe = { x: 350, y: sueloY - 150, w: 120, h: 150, hp: 100, maxHp: 100, vivo: true, mirandoIzquierda: true };
    const ladron = { x: 700, y: sueloY - 140, w: 100, h: 140, hp: 80, maxHp: 80, vivo: true, mirandoIzquierda: true };
    let proyectiles = [];
    const muros = [{x: 200, y: 0, w: 40, h: 300}, {x: 400, y: 150, w: 40, h: 300}, {x: 600, y: 0, w: 40, h: 250}];
    let llave = { x: 350, y: 60, obtenida: false };
    let puerta = { x: 645, y: 300, w: 150, h: 140 };

    function iniciarJuego() {
        document.getElementById('pantallaInicio').style.display = 'none';
        juegoActivo = true;
        sfxFondo.play().catch(()=>{});
        loop();
    }

    // --- CONTROLES M√ìVILES ---
    const vincularTouch = (id, tecla) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); keys[tecla] = true; 
            if(tecla === 'KeyZ') { carlos.atacando = true; sfxAtaque.play().catch(()=>{}); }
        });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[tecla] = false; if(tecla === 'KeyZ') carlos.atacando = false; });
    };
    vincularTouch('tIzq', 'ArrowLeft');
    vincularTouch('tDer', 'ArrowRight');
    vincularTouch('tUp', 'ArrowUp');
    vincularTouch('tDown', 'ArrowDown');
    vincularTouch('tAtk', 'KeyZ');

    // --- CONTROLES TECLADO ---
    window.addEventListener('keydown', e => {
        if(e.code === 'KeyZ' || e.code === 'Space') { carlos.atacando = true; sfxAtaque.play().catch(()=>{}); }
        keys[e.code] = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'KeyZ' || e.code === 'Space') carlos.atacando = false;
        keys[e.code] = false;
    });

    function detenerMusica() { sfxFondo.pause(); sfxFondo.currentTime = 0; }

    function checkColision(nx, ny) {
        if (nivel === 3) {
            for (let m of muros) {
                if (nx < m.x + m.w && nx + carlos.w > m.x && ny < m.y + m.h && ny + carlos.h > m.y) return true;
            }
        }
        if (nx < 0 || nx + carlos.w > canvas.width || ny < 0 || ny + carlos.h > canvas.height) return true;
        return false;
    }

    // ATAQUES M√öLTIPLES RESTAURADOS
    function dispararEnemigo(obj, tipo) {
        sfxEnemigo.play().catch(()=>{});
        let dir = obj.x > carlos.x ? -1 : 1;
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: 0, tipo: tipo });
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: -2, tipo: tipo });
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: 2, tipo: tipo });
    }

    function actualizar() {
        if (!juegoActivo || carlos.muerto) return;

        let sigX = carlos.x;
        let sigY = carlos.y;

        if (keys['ArrowLeft']) { sigX -= carlos.speed; mirandoIzquierda = true; }
        if (keys['ArrowRight']) { sigX += carlos.speed; mirandoIzquierda = false; }
        if (!checkColision(sigX, carlos.y)) carlos.x = sigX;

        if (nivel < 3) {
            if (keys['ArrowUp'] && carlos.enSuelo) { carlos.vy = carlos.salto; carlos.enSuelo = false; }
            carlos.vy += carlos.gravedad;
            sigY += carlos.vy;
            if (sigY >= sueloY - carlos.h) { sigY = sueloY - carlos.h; carlos.vy = 0; carlos.enSuelo = true; }
            if (!checkColision(carlos.x, sigY)) carlos.y = sigY;
        } else {
            if (keys['ArrowUp']) sigY -= carlos.speed;
            if (keys['ArrowDown']) sigY += carlos.speed;
            if (!checkColision(carlos.x, sigY)) carlos.y = sigY;
        }

        // PULLAS NIVEL 3
        if (nivel === 3) {
            for (let m of muros) {
                if (carlos.x < m.x + m.w + 15 && carlos.x + carlos.w > m.x - 15 && carlos.y < m.y + m.h && carlos.y + carlos.h > m.y) {
                    carlos.hp -= 0.5;
                    if (mirandoIzquierda) carlos.x += 10; else carlos.x -= 10;
                }
            }
        }

        // JEFE NIVEL 1
        if (nivel === 1 && jefe.vivo) {
            jefe.mirandoIzquierda = (jefe.x > carlos.x);
            if (Math.random() < 0.02) dispararEnemigo(jefe, 'üìÑ');
            if (carlos.atacando && Math.abs(carlos.x - jefe.x) < 120 && Math.abs(carlos.y - jefe.y) < 100) {
                jefe.hp -= 1;
                if (jefe.hp <= 0) { jefe.vivo = false; setTimeout(() => { nivel = 2; carlos.x = 50; }, 800); }
            }
        }

        // LADR√ìN NIVEL 2
        if (nivel === 2 && ladron.vivo) {
            ladron.mirandoIzquierda = (ladron.x > carlos.x);
            ladron.x += (ladron.x > carlos.x ? -3 : 3);
            if (Math.random() < 0.03) dispararEnemigo(ladron, 'üî™');
            if (carlos.atacando && Math.abs(carlos.x - ladron.x) < 100) {
                ladron.hp -= 1.5;
                if (ladron.hp <= 0) { ladron.vivo = false; setTimeout(() => { nivel = 3; carlos.x = 50; carlos.y = 50; }, 800); }
            }
        }

        // PROYECTILES CON TRAYECTORIA COMPLETA
        for (let i = proyectiles.length - 1; i >= 0; i--) {
            proyectiles[i].x += proyectiles[i].vx;
            proyectiles[i].y += proyectiles[i].vy;
            if (Math.abs(proyectiles[i].x - (carlos.x + 30)) < 40 && Math.abs(proyectiles[i].y - (carlos.y + 50)) < 50) {
                if(!carlos.atacando) carlos.hp -= 5; proyectiles.splice(i, 1);
            } else if (proyectiles[i].x < 0 || proyectiles[i].x > canvas.width) {
                proyectiles.splice(i, 1);
            }
        }

        if (nivel === 3) {
            if (!llave.obtenida && Math.abs(carlos.x - llave.x) < 50 && Math.abs(carlos.y - llave.y) < 50) llave.obtenida = true;
            if (llave.obtenida && carlos.x > puerta.x - 50 && carlos.y > puerta.y - 50) {
                juegoActivo = false; detenerMusica(); 
                sfxFinal2.loop = true; sfxFinal2.play(); sfxFinal1.play();
                document.getElementById('pantallaFinal').style.display = 'flex';
                animarChicaFinal();
            }
        }

        if (carlos.hp <= 0 && !carlos.muerto) {
            carlos.muerto = true; detenerMusica(); sfxPerder.play();
        }
    }

    function animarChicaFinal() {
        let frame = 1;
        const imgElement = document.getElementById('chicaAnimada');
        setInterval(() => {
            frame = (frame % 4) + 1;
            imgElement.src = `img/chica${frame}.png`;
            let scaleX = Math.sin(Date.now() / 800);
            imgElement.style.transform = `scaleX(${scaleX})`;
        }, 200);
    }

    function dibujar() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let fondo = nivel === 1 ? imgFondo1 : (nivel === 2 ? imgFondo2 : imgFondo3);
        ctx.drawImage(fondo, 0, 0, 800, 450);

        if (nivel === 3) {
            muros.forEach(m => {
                let grad = ctx.createLinearGradient(m.x, m.y, m.x, m.y + m.h);
                grad.addColorStop(0, "#1e8449"); grad.addColorStop(1, "#145a32");
                ctx.fillStyle = grad; ctx.fillRect(m.x, m.y, m.w, m.h);
                ctx.fillStyle = "#ecf0f1";
                for (let py = m.y; py < m.y + m.h; py += 20) {
                    ctx.beginPath(); ctx.moveTo(m.x, py); ctx.lineTo(m.x - 30, py + 40); ctx.lineTo(m.x, py + 10); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(m.x + m.w, py); ctx.lineTo(m.x + m.w + 30, py + 40); ctx.lineTo(m.x + m.w, py + 10); ctx.fill();
                }
            });
            if(!llave.obtenida) { ctx.font = "40px Arial"; ctx.fillText("üîë", llave.x, llave.y + 35); }
            ctx.drawImage(imgPuerta, puerta.x, puerta.y, puerta.w, puerta.h);
        }

        let serie = carlos.muerto ? sprites.pierde : (carlos.atacando ? sprites.ataca : (carlos.enSuelo || nivel === 3 ? sprites.camina : sprites.salta));
        if (carlos.muerto && animFrame === 3) document.getElementById('pantallaPerder').style.display = 'flex';
        
        animTimer++;
        if (animTimer >= 8) { animFrame = (animFrame + 1) % (carlos.muerto ? 4 : (carlos.atacando ? 4 : 6)); animTimer = 0; }

        ctx.save();
        if (mirandoIzquierda) { ctx.translate(carlos.x + carlos.w, carlos.y); ctx.scale(-1, 1); ctx.drawImage(serie[animFrame] || serie[0], 0, 0, carlos.w, carlos.h); }
        else { ctx.drawImage(serie[animFrame] || serie[0], carlos.x, carlos.y, carlos.w, carlos.h); }
        ctx.restore();

        if (nivel === 1 && jefe.vivo) {
            ctx.save();
            if(!jefe.mirandoIzquierda) { ctx.translate(jefe.x + jefe.w, jefe.y); ctx.scale(-1, 1); ctx.drawImage(imgJefe, 0, 0, jefe.w, jefe.h); }
            else { ctx.drawImage(imgJefe, jefe.x, jefe.y, jefe.w, jefe.h); }
            ctx.restore();
            dibujarBarraVida(jefe.x, jefe.y - 20, jefe.w, jefe.hp, jefe.maxHp, "red");
        }
        if (nivel === 2 && ladron.vivo) {
            ctx.save();
            if(!ladron.mirandoIzquierda) { ctx.translate(ladron.x + ladron.w, ladron.y); ctx.scale(-1, 1); ctx.drawImage(imgLadron, 0, 0, ladron.w, ladron.h); }
            else { ctx.drawImage(imgLadron, ladron.x, ladron.y, ladron.w, ladron.h); }
            ctx.restore();
            dibujarBarraVida(ladron.x, ladron.y - 20, ladron.w, ladron.hp, ladron.maxHp, "red");
        }

        proyectiles.forEach(p => { ctx.font = "30px Arial"; ctx.fillText(p.tipo, p.x, p.y); });
        dibujarBarraVida(20, 30, 200, carlos.hp, 100, "#48ff00");
    }

    function dibujarBarraVida(x, y, w, actual, max, color) {
        ctx.fillStyle = "black"; ctx.fillRect(x, y, w, 10);
        ctx.fillStyle = color; ctx.fillRect(x, y, Math.max(0, actual/max) * w, 10);
    }

    function loop() { if(juegoActivo || carlos.muerto) { actualizar(); dibujar(); } requestAnimationFrame(loop); }
</script>
</body>
</html>
