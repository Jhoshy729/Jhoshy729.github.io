<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carlos: Expedici√≥n Extrema</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; overflow: hidden; touch-action: none; 
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 56.25vw; 
            max-height: 100vh;
            max-width: 177.78vh;
        }

        canvas { width: 100%; height: 100%; border: 2px solid #444; display: block; }
        
        .overlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; z-index: 100; padding: 20px; background: rgba(0,0,0,0.85);
        }
        
        #pantallaInicio { display: flex; }
        #pantallaFinal { background: linear-gradient(135deg, #0919ac, #fe7b7b); color: #000; text-shadow: 0 0 10px white; }
        #chicaAnimada { width: 120px; height: 150px; margin-bottom: 10px; }
        
        .btn-ui { padding: 15px 30px; font-size: 20px; font-weight: bold; cursor: pointer; background: #ff4757; color: white; border: none; border-radius: 50px; margin-top: 15px; }
        
        /* --- CONTROLES M√ìVILES --- */
        #controles-movil { 
            position: fixed; bottom: 8%; width: 100%; 
            display: none; justify-content: space-between; 
            padding: 0 40px; z-index: 1000; pointer-events: none; 
        }
        
        .cruceta { 
            display: grid; 
            grid-template-areas: ". up ." "left . right" ". down .";
            gap: 10px; pointer-events: auto;
        }
        
        .btn-touch { 
            width: 75px; height: 75px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 28px; font-weight: bold; color: white;
            user-select: none; border: 3px solid rgba(255,255,255,0.4);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            background: rgba(0, 150, 255, 0.4); backdrop-filter: blur(5px);
        }

        .btn-touch:active { transform: scale(0.9); background: rgba(0, 150, 255, 0.8); }

        #tUp { grid-area: up; }
        #tDown { grid-area: down; }
        #tIzq { grid-area: left; }
        #tDer { grid-area: right; }

        .grupo-der { display: flex; align-items: center; pointer-events: auto; }
        
        .btn-ataque { 
            background: rgba(255, 50, 50, 0.7); width: 100px; height: 100px; 
            border-color: rgba(255,255,255,0.6); font-size: 18px;
        }

        @media (pointer: coarse) { #controles-movil { display: flex; } }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="pantallaInicio" class="overlay">
             <h1>„Ç´„É´„É≠„Çπ: EXPEDICI√ìN sopresa</h1>
        <p> Hola...ÊÑõ„Åó„Å¶„Åæ„Åô.</p>
            <button class="btn-ui" onclick="iniciarJuego()">¬°INICIAR!</button>
        </div>

        <div id="pantallaFinal" class="overlay">
            <img id="chicaAnimada" src="img/chica1.png">
           <h1>üéÇ ¬°MISI√ìN CUMPLIDA CARLOS! üéÇ</h1>
        <h3>Feliz cumplea√±os mi terroncito de az√∫car, tarde muchas noches programando y pensando en c√≥mo hacerte una aventura especial... Te amo mucho mi vida. ‚ù§Ô∏è</h3>
        <p>¬°Hora De Comer Pastel, √ëan √ëan!</p>
            <button class="btn-ui" onclick="location.reload()">REINICIAR</button>
        </div>

        <div id="pantallaPerder" class="overlay">
            <h1>HAS CA√çDO EN COMBATE</h1>
            <button class="btn-ui" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <div id="controles-movil">
        <div class="cruceta">
            <div id="tUp" class="btn-touch">‚Üë</div>
            <div id="tDown" class="btn-touch">‚Üì</div>
            <div id="tIzq" class="btn-touch">‚Üê</div>
            <div id="tDer" class="btn-touch">‚Üí</div>
        </div>
        <div class="grupo-der">
            <div id="tAtk" class="btn-touch btn-ataque">ATACA!</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 450;

    // --- RECURSOS ---
    const imgFondo1 = new Image(); imgFondo1.src = 'img/fondo_nivel1.png';
    const imgFondo2 = new Image(); imgFondo2.src = 'img/fondo_nivel2.png';
    const imgFondo3 = new Image(); imgFondo3.src = 'img/fondo_nivel3.jpeg';
    const imgPuerta = new Image(); imgPuerta.src = 'img/puerta.png';
    const imgJefe = new Image(); imgJefe.src = 'img/jefe.png';
    const imgLadron = new Image(); imgLadron.src = 'img/ladron.png';

    function cargarSerie(nombre, total) {
        let temp = [];
        for(let i=1; i<=total; i++) {
            let img = new Image(); img.src = `img/${nombre}${i}.png`;
            temp.push(img);
        }
        return temp;
    }

    const sprites = {
        camina: cargarSerie('carlos_camina', 6),
        salta: cargarSerie('carlos_salta', 6),
        ataca: cargarSerie('carlos_ataca', 4),
        pierde: cargarSerie('carlos_pierde', 4)
    };

    const sfxFondo = new Audio('audio_nivel.mp3'); sfxFondo.loop = true;
    const sfxAtaque = new Audio('audio_ataque.mp3');
    const sfxEnemigo = new Audio('audio_enemigo.mp3');
    const sfxPerder = new Audio('audio_perder.mp3');
    const sfxFinal1 = new Audio('audio_final1.mp3');
    const sfxFinal2 = new Audio('audio_final2.mp3');

    let nivel = 1; let juegoActivo = false; let mirandoIzquierda = false;
    let animFrame = 0; let animTimer = 0;
    const sueloY = 380;
    const keys = {};

    const carlos = { x: 50, y: sueloY - 150, w: 70, h: 120, hp: 100, vy: 0, gravedad: 1.2, salto: -20, enSuelo: true, speed: 6, atacando: false, muerto: false };
    const jefe = { x: 350, y: sueloY - 150, w: 120, h: 150, hp: 100, maxHp: 100, vivo: true };
    const ladron = { x: 700, y: sueloY - 140, w: 100, h: 140, hp: 80, maxHp: 80, vivo: true };
    let proyectiles = [];
    const muros = [{x: 200, y: 0, w: 40, h: 300}, {x: 400, y: 150, w: 40, h: 300}, {x: 600, y: 0, w: 40, h: 250}];
    let llave = { x: 350, y: 60, obtenida: false };
    let puerta = { x: 645, y: 300, w: 150, h: 140 };

    function iniciarJuego() {
        document.getElementById('pantallaInicio').style.display = 'none';
        juegoActivo = true;
        sfxFondo.play().catch(()=>{});
        loop();
    }

    // --- ESCUCHA DE TECLADO (PC) ---
    window.addEventListener('keydown', e => {
        keys[e.code] = true;
        if(e.code === 'KeyZ' || e.code === 'Space') { carlos.atacando = true; sfxAtaque.play().catch(()=>{}); }
    });
    window.addEventListener('keyup', e => {
        keys[e.code] = false;
        if(e.code === 'KeyZ' || e.code === 'Space') carlos.atacando = false;
    });

    // --- ESCUCHA DE TOUCH (M√ìVIL) ---
    const vincularTouch = (id, tecla) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); keys[tecla] = true; 
            if(tecla === 'KeyZ') { carlos.atacando = true; sfxAtaque.play().catch(()=>{}); }
        });
        el.addEventListener('touchend', (e) => { 
            e.preventDefault(); keys[tecla] = false; 
            if(tecla === 'KeyZ') carlos.atacando = false; 
        });
    };
    vincularTouch('tIzq', 'ArrowLeft');
    vincularTouch('tDer', 'ArrowRight');
    vincularTouch('tUp', 'ArrowUp');
    vincularTouch('tDown', 'ArrowDown');
    vincularTouch('tAtk', 'KeyZ');

    function dispararEnemigo(obj, tipo) {
        sfxEnemigo.play().catch(()=>{});
        let dir = obj.x > carlos.x ? -1 : 1;
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: 0, tipo: tipo });
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: -2, tipo: tipo });
        proyectiles.push({ x: obj.x, y: obj.y + 60, vx: dir * 7, vy: 2, tipo: tipo });
    }

    function actualizar() {
        if (!juegoActivo || carlos.muerto) return;

        let sigX = carlos.x;
        let sigY = carlos.y;

        if (keys['ArrowLeft']) { sigX -= carlos.speed; mirandoIzquierda = true; }
        if (keys['ArrowRight']) { sigX += carlos.speed; mirandoIzquierda = false; }
        
        if (nivel === 3) {
            for (let m of muros) {
                if (sigX < m.x + m.w && sigX + carlos.w > m.x && sigY < m.y + m.h && sigY + carlos.h > m.y) sigX = carlos.x;
            }
        }
        if (sigX >= 0 && sigX + carlos.w <= canvas.width) carlos.x = sigX;

        if (nivel < 3) {
            if (keys['ArrowUp'] && carlos.enSuelo) { carlos.vy = carlos.salto; carlos.enSuelo = false; }
            carlos.vy += carlos.gravedad;
            sigY += carlos.vy;
            if (sigY >= sueloY - carlos.h) { sigY = sueloY - carlos.h; carlos.vy = 0; carlos.enSuelo = true; }
            carlos.y = sigY;
        } else {
            if (keys['ArrowUp']) sigY -= carlos.speed;
            if (keys['ArrowDown']) sigY += carlos.speed;
            if (sigY >= 0 && sigY + carlos.h <= canvas.height) {
                let colMuro = false;
                for (let m of muros) {
                    if (carlos.x < m.x + m.w && carlos.x + carlos.w > m.x && sigY < m.y + m.h && sigY + carlos.h > m.y) colMuro = true;
                }
                if(!colMuro) carlos.y = sigY;
            }
            
            for (let m of muros) {
                if (carlos.x < m.x + m.w + 10 && carlos.x + carlos.w > m.x - 10 && carlos.y < m.y + m.h && carlos.y + carlos.h > m.y) {
                    carlos.hp -= 0.5;
                }
            }
        }

        if (nivel === 1 && jefe.vivo) {
            if (Math.random() < 0.02) dispararEnemigo(jefe, 'üìÑ');
            if (carlos.atacando && Math.abs(carlos.x - jefe.x) < 120) {
                jefe.hp -= 1;
                if (jefe.hp <= 0) { jefe.vivo = false; setTimeout(() => { nivel = 2; carlos.x = 50; }, 800); }
            }
        }

        if (nivel === 2 && ladron.vivo) {
            ladron.x += (ladron.x > carlos.x ? -3 : 3);
            if (Math.random() < 0.03) dispararEnemigo(ladron, 'üî™');
            if (carlos.atacando && Math.abs(carlos.x - ladron.x) < 100) {
                ladron.hp -= 1.5;
                if (ladron.hp <= 0) { ladron.vivo = false; setTimeout(() => { nivel = 3; carlos.x = 50; carlos.y = 50; }, 800); }
            }
        }

        for (let i = proyectiles.length - 1; i >= 0; i--) {
            proyectiles[i].x += proyectiles[i].vx;
            proyectiles[i].y += proyectiles[i].vy;
            if (Math.abs(proyectiles[i].x - (carlos.x + 30)) < 40 && Math.abs(proyectiles[i].y - (carlos.y + 50)) < 50) {
                if(!carlos.atacando) carlos.hp -= 5; proyectiles.splice(i, 1);
            }
        }

        if (nivel === 3 && llave.obtenida && carlos.x > puerta.x - 50 && carlos.y > puerta.y - 50) {
            juegoActivo = false; sfxFondo.pause(); sfxFinal2.loop = true; sfxFinal2.play(); sfxFinal1.play();
            document.getElementById('pantallaFinal').style.display = 'flex';
            animarChicaFinal();
        }
        if (nivel === 3 && !llave.obtenida && Math.abs(carlos.x - llave.x) < 50 && Math.abs(carlos.y - llave.y) < 50) llave.obtenida = true;

        if (carlos.hp <= 0 && !carlos.muerto) {
            carlos.muerto = true; sfxFondo.pause(); sfxPerder.play();
            setTimeout(() => { document.getElementById('pantallaPerder').style.display = 'flex'; }, 1000);
        }
    }

    function animarChicaFinal() {
        let frame = 1;
        const img = document.getElementById('chicaAnimada');
        setInterval(() => {
            frame = (frame % 4) + 1;
            img.src = `img/chica${frame}.png`;
        }, 200);
    }

    function dibujar() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let fondo = nivel === 1 ? imgFondo1 : (nivel === 2 ? imgFondo2 : imgFondo3);
        ctx.drawImage(fondo, 0, 0, 800, 450);

        if (nivel === 3) {
            muros.forEach(m => {
                ctx.fillStyle = "#1e8449"; ctx.fillRect(m.x, m.y, m.w, m.h);
                ctx.fillStyle = "white";
                for (let py = m.y; py < m.y + m.h; py += 25) {
                    ctx.beginPath(); ctx.moveTo(m.x, py); ctx.lineTo(m.x - 20, py + 10); ctx.lineTo(m.x, py + 20); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(m.x + m.w, py); ctx.lineTo(m.x + m.w + 20, py + 10); ctx.lineTo(m.x + m.w, py + 20); ctx.fill();
                }
            });
            if(!llave.obtenida) { ctx.font = "30px Arial"; ctx.fillText("üîë", llave.x, llave.y + 30); }
            ctx.drawImage(imgPuerta, puerta.x, puerta.y, puerta.w, puerta.h);
        }

        let serie = carlos.muerto ? sprites.pierde : (carlos.atacando ? sprites.ataca : (carlos.enSuelo || nivel === 3 ? sprites.camina : sprites.salta));
        animTimer++;
        if (animTimer >= 8) { animFrame = (animFrame + 1) % serie.length; animTimer = 0; }

        ctx.save();
        if (mirandoIzquierda) { ctx.translate(carlos.x + carlos.w, carlos.y); ctx.scale(-1, 1); ctx.drawImage(serie[animFrame] || serie[0], 0, 0, carlos.w, carlos.h); }
        else { ctx.drawImage(serie[animFrame] || serie[0], carlos.x, carlos.y, carlos.w, carlos.h); }
        ctx.restore();

        if (nivel === 1 && jefe.vivo) {
            ctx.drawImage(imgJefe, jefe.x, jefe.y, jefe.w, jefe.h);
            dibujarBarraVida(jefe.x, jefe.y - 15, jefe.w, jefe.hp, 100, "red");
        }
        if (nivel === 2 && ladron.vivo) {
            ctx.drawImage(imgLadron, ladron.x, ladron.y, ladron.w, ladron.h);
            dibujarBarraVida(ladron.x, ladron.y - 15, ladron.w, ladron.hp, 80, "red");
        }

        proyectiles.forEach(p => { ctx.font = "25px Arial"; ctx.fillText(p.tipo, p.x, p.y); });
        dibujarBarraVida(20, 30, 150, carlos.hp, 100, "#48ff00");
    }

    function dibujarBarraVida(x, y, w, actual, max, color) {
        ctx.fillStyle = "black"; ctx.fillRect(x, y, w, 8);
        ctx.fillStyle = color; ctx.fillRect(x, y, (actual/max) * w, 8);
    }

    function loop() { if(juegoActivo || carlos.muerto) { actualizar(); dibujar(); } requestAnimationFrame(loop); }
</script>
</body>
</html>
